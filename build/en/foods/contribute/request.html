<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Food Info</title>
    <meta name="description" content="Allows requesting different foods from the APBD Foods List directly via the website. Try it out - Help a cause!">

    <link rel="stylesheet" href="../style/main.css">
    <link rel="stylesheet" href="../style/dropdown.css">
    <link rel="stylesheet" href="../style/contribute.css">
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VPXMF38X8C"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-VPXMF38X8C');
</script></head>

<!-- Google tag (gtag.js) -->



<body>

    <script>
        const touch = matchMedia('(hover: none)').matches
        console.log(touch);

        if (touch) {
            let prev = window.document.body;
            window.addEventListener("touchend", function (e) {
                if (e.target.onclick) e.target.onclick();
                if (prev !== e.target) prev.classList.remove("hover");
                e.target.classList.toggle("hover");
                prev = e.target;
                console.log(e.target);
            }, { passive: false });
        }
    </script>
    <header>
        <div class="logo">
            <img src="../favicon.ico" alt="Website logo">
            <div class="column">
                <a class="title" href="https://apbd.net">APBD.net</a>
                <a class="sub" href="#" onclick="window.location.href = window.location.origin + window.location.search">Allowed Foods List</a>
            </div>

        </div>
        <nav class="header-menu">
            <div class="dropdown">
                <a id="about" href="#">About</a>
                <div class="dropdown-content">
                    <a target="_blank" href="https://github.com/ShaharMS/APBD-FoodList/blob/main/README.md">Website</a>
                    <a target="_blank" href="https://rarediseases.org/rare-diseases/adult-polyglucosan-body-disease/">APBD
                        <span>‚Üó</span></a>
                    <a onclick="window.location.href = window.location.origin + `/about/database${'_' + (new URLSearchParams(window.location.search).get('lang') || 'en')}.html` + window.location.search" href="#">Food Database</a>
                </div>
            </div>
            <div class="dropdown">
                <a id="contribute" href="#">Contribute</a>
                <div class="dropdown-content">
                    <a href="./contribute/request.html">Request data</a>
                    <a href="./contribute/provide.html">Provide data</a>
                    <a href="./contribute/leaderboards.html">Leaderboards</a>
                </div>
            </div>

            <div class="dropdown">
                <a id="contact" href="#">Language</a>
                <div class="dropdown-content">
                    <a onclick="window.location.href = window.location.href.replace(new RegExp('he|en'), 'en')" href="#">English</a>
                    <a onclick="window.location.href = window.location.href.replace(new RegExp('he|en'), 'he')" href="#">Hebrew</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <blockquote>This page exists to help you and other people, by expanding the list of documented foods. Don't hesitate to choose "I dont know" or "I'm not sure". I've got your back :)</blockquote>

        <div class="request-options">
            <div class="column">
                <h2>Request Using: Details</h2>
                <form id="request-form">
                    <table id="request-table">
                        <tbody><tr>
                            <th>
                                <help>Your first and last name. Used to add this contribution to the leaderboards, under your name. Contribute enough, and maybe one day you'll get to 1st place üòÅ</help>
                                <span>Name</span>
                            </th>
                            <td>
                                <input id="name" placeholder="First and last name...">
                                <div class="button-row">
                                    <button id="n-np" type="button">I'd rather not provide</button>
                                </div>
                            </td>
                        </tr>
                        <tr>

                            <th>
                                <help>The Food's name. More useful to leave a concise name here, and if a company is involved, mention it after the fact.</help>
                                <span>Food name (english)</span>
                            </th>
                            <td>
                                <input id="food-name-english" placeholder="Food name...">
                                <div class="button-row">
                                    <button id="fn-ns" type="button">I'm not sure</button>
                                    <button id="fn-dk" type="button">I don't know</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>
                                <help>For Translation purposes, It is a good idea to add the name in Hebrew. (makes my job a little easier üôÉ)</help>
                                <span>Food name (hebrew)</span>
                            </th>
                            <td>
                                <input id="food-name-hebrew" placeholder="◊©◊ù ◊î◊û◊ê◊õ◊ú...">
                                <div class="button-row">
                                    <button id="t-ns" type="button">I'm not sure</button>
                                    <button id="t-dk" type="button">I don't know</button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>
                                <help>If the specific food you're requesting is produced by a specific company, mention it here, This allows me to tag the item with the company and it's logo.</help>
                                <span>Optional: Food's Company</span>
                            </th>
                            <td>
                                <input id="company" list="companies" placeholder="Company Name...">
                                <div class="button-row">
                                    <button id="co-ns" type="button">I'm not sure</button>
                                    <button id="co-dk" type="button">I don't know</button>
                                </div>
                            </td>
                        </tr>
                    </tbody></table>
                </form>
            </div>


            <h3>Or</h3>

            <div class="column">
                <h2>Request Using: Images</h2>
                <form id="image-request-form">
                    <table id="image-request-table">
                        <tbody><tr>
                            <th>
                                <help>The way the food looks from the front. On packaged food, usually contains the name of the food, it's company and what it actually is.</help>
                                <span>Food/Packaging's Front</span>
                            </th>
                            <td>
                                <div style="display: flex; width: 100%; flex-direction: row; justify-content: center;">
                                    <img width="0" height="0" style="display: none;">
                                </div>
                                <div class="button-row">
                                    <button type="button" onclick="takeAndDisplay(this.parentElement.parentElement)">Take Image</button>
                                    <label for="image-picker">Pick from the Gallery...</label>
                                    <input id="image-picker" type="file" accept="image/*" placeholder="Choose from the Gallery...">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>
                                <help>The way the food looks from the back. On packaged food, usually contains the food's nutrition facts, its ingredients, and more details about the food/its comapny.</help>
                                <span>Food/Packaging's Back</span>
                            </th>
                            <td>
                                <div style="display: flex; width: 100%; flex-direction: row; justify-content: center;">
                                    <img width="0" height="0" style="display: none;">
                                </div>
                                <div class="button-row">
                                    <button type="button" onclick="takeAndDisplay(this.parentElement.parentElement)">Take Image</button>
                                    <label for="image-picker">Pick from the Gallery...</label>
                                    <input id="image-picker" type="file" accept="image/*" placeholder="Choose from the Gallery...">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>
                                <help>Some food packages are thick, and contain extra info on one of their sides (for example, a cereal box). Use this field to provide an image, if necessary.</help>
                                <span>Optional: Food/Packaging's Side</span>
                            </th>
                            <td>
                                <div style="display: flex; width: 100%; flex-direction: row; justify-content: center;">
                                    <img width="0" height="0" style="display: none;">
                                </div>
                                <div class="button-row">
                                    <button type="button" onclick="takeAndDisplay(this.parentElement.parentElement)">Take Image</button>
                                    <label for="image-picker">Pick from the Gallery...</label>
                                    <input id="image-picker" type="file" accept="image/*" placeholder="Choose from the Gallery...">
                                </div>
                            </td>
                        </tr>
                    </tbody></table>
                </form>
            </div>

        </div>


        <div class="row">
            <button type="submit" id="submit">Submit</button>
        </div>
        <h3 id="submition-output"></h3>


    </div>

    <script src="../code/help-marks.js"></script>
    <script src="../code/choice-buttons.js"></script>
    <script src="../code/food-name-validator.js"></script>
    <script src="../code/image-processor.js"></script>

    <script>
        String.prototype.attemptedXSS = function () {
            return /[<>]/.test(this);
        }
        let submit = document.getElementById("submit");
        let output = document.getElementById("submition-output");
        submit.onclick = () => {
            console.log(languageIndex);
            let notice = confirm("Are you sure you want to submit?");
            if (!notice) return;

            submit.textContent = "Submitting...";

            output.innerHTML = "Grabbing Data From Text Fields...";

            let name = document.getElementById("name").value;
            let name_RatherNotProvide = document.getElementById("n-np").classList.contains("selected");

            if (name.length === 0 && !name_RatherNotProvide) {
                output.innerHTML = "Please provide a name, or select 'I'd rather not provide'.";
                submit.textContent = "Submit";
                return;
            }

            let foodName = document.getElementById("food-name-english").value;
            let foodName_NotSure = document.getElementById("fn-ns").classList.contains("selected");
            let foodName_DontKnow = document.getElementById("fn-dk").classList.contains("selected");

            if (foodName.length === 0 && !foodName_DontKnow) {
                output.innerHTML = "Please provide an english translation of the food name, or select 'I don't know'.";
                submit.textContent = "Submit";
                return;
            }

            let translations = document.getElementById("food-name-hebrew").value;
            let translations_NotSure = document.getElementById("t-ns").classList.contains("selected");
            let translations_DontKnow = document.getElementById("t-dk").classList.contains("selected");

            if (translations.length === 0 && !translations_DontKnow) {
                output.innerHTML = "Please provide a hebrew translation of the food name, or select 'I don't know'.";
                submit.textContent = "Submit";
                return;
            }

            output.innerHTML = "Testing For Attempted XSS Attacks...";

            if (name.attemptedXSS() || foodName.attemptedXSS() || translations.attemptedXSS()) {
                output.innerHTML = "Nice try üòâ";
                submit.textContent = "Submit";
                return;
            }

            if (document.getElementById("food-name-english").classList.contains("already-exists") || document.getElementById("food-name-hebrew").classList.contains("already-exists")) {
                output.innerHTML = "Food already exists in the food list.";
                submit.textContent = "Submit";
                return;
            }

            output.innerHTML = "Building Request Packet...";

            let payload = {
                type: "request",
                name: name.length === 0 || name_RatherNotProvide ? "Anonymous" : name,
                foodEnglish: foodName.length === 0 ? "Not Given" : foodName,
                foodEnglishSecurity: foodName_DontKnow ? 0 : (foodName_NotSure ? 1 : 2),
                foodHebrew: translations.length === 0 || translations_DontKnow ? "Not Given" : translations,
                foodHebrewSecurity: translations_DontKnow ? 0 : (translations_NotSure ? 1 : 2),
            }

            if (foodName_DontKnow && translations_DontKnow) {
                // Ignore "nonsense" requests
                output.innerHTML = "Request not submitted: no information provided.";
                submit.textContent = "Submit";
                return;
            } else {
                output.innerHTML = "Sending Request Packet...";
                fetch("https://apbd-contrib-bot.shaharmsecond.workers.dev/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                })
                    .then(response => {
                        output.innerHTML = "Getting Response...";
                        return response.text();
                    })
                    .then(data => {
                        output.innerHTML = data;
                        submit.textContent = "Submit";
                    });
            }
        }
    </script>

    <script type="module">
        let urlParams = new URLSearchParams(window.location.search);

        let lang = urlParams.get("lang") || "en";
        activateHelpMarks();
        activateChoiceButtons();
        activateFoodNameValidator();
    </script>


</body></html>